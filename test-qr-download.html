<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Download Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .qr-container {
            text-align: center;
            margin: 20px 0;
        }
        #qrcode {
            margin: 20px auto;
        }
        .btn {
            background-color: #6f42c1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background-color: #5a2d91;
        }
        .debug-log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>QR Code Download Test</h1>
        <p>This is a test page to debug the QR code download functionality.</p>
        
        <div class="qr-container">
            <div id="qrcode"></div>
            <br>
            <button class="btn" onclick="downloadQRCode()">Download QR Code</button>
            <button class="btn" onclick="shareQRCode()">Share QR Code</button>
        </div>
        
        <div class="debug-log" id="debugLog">
            <strong>Debug Log:</strong><br>
        </div>
    </div>

    <script>
        // Debug logging function
        function debugLog(message) {
            const logElement = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[QR Debug] ${message}`);
        }

        // Test member data
        const memberData = {
            mobile: "09180000001",
            name: "Member1 Test",
            wallet_balance: 100.00
        };

        // Generate QR code on page load
        window.addEventListener('DOMContentLoaded', function() {
            debugLog('Page loaded, generating QR code...');
            generateQRCode();
        });

        function generateQRCode() {
            try {
                debugLog('Starting QR code generation...');
                
                const qrData = JSON.stringify({
                    type: 'payment',
                    mobile: memberData.mobile,
                    name: memberData.name,
                    wallet_balance: memberData.wallet_balance
                });
                
                debugLog(`QR Data: ${qrData}`);
                
                const qrContainer = document.getElementById('qrcode');
                qrContainer.innerHTML = ''; // Clear existing QR code
                
                // Create QR code using qrcode-generator library
                const qr = qrcode(0, 'M');
                qr.addData(qrData);
                qr.make();
                
                // Create canvas
                const canvas = document.createElement('canvas');
                canvas.id = 'qrCanvas';
                const ctx = canvas.getContext('2d');
                
                const moduleCount = qr.getModuleCount();
                const cellSize = 8;
                const margin = 16;
                const size = moduleCount * cellSize + margin * 2;
                
                canvas.width = size;
                canvas.height = size;
                
                // Fill background
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, size, size);
                
                // Draw QR modules
                ctx.fillStyle = '#000000';
                for (let row = 0; row < moduleCount; row++) {
                    for (let col = 0; col < moduleCount; col++) {
                        if (qr.isDark(row, col)) {
                            ctx.fillRect(
                                col * cellSize + margin,
                                row * cellSize + margin,
                                cellSize,
                                cellSize
                            );
                        }
                    }
                }
                
                // Add styling
                canvas.style.border = '2px solid #6f42c1';
                canvas.style.borderRadius = '10px';
                canvas.style.width = '200px';
                canvas.style.height = '200px';
                
                qrContainer.appendChild(canvas);
                
                debugLog('QR code generated successfully');
                
            } catch (error) {
                debugLog(`QR generation exception: ${error.message}`);
            }
        }

        function downloadQRCode() {
            debugLog('=== Starting QR Code Download ===');
            
            try {
                // Get the displayed QR canvas
                const displayedCanvas = document.getElementById('qrCanvas');
                if (!displayedCanvas) {
                    debugLog('ERROR: QR canvas not found');
                    return;
                }
                
                debugLog('Found QR canvas, creating download canvas...');
                
                // Create a new canvas for download
                const downloadCanvas = document.createElement('canvas');
                const downloadCtx = downloadCanvas.getContext('2d');
                
                // Set canvas size
                downloadCanvas.width = 400;
                downloadCanvas.height = 400;
                
                debugLog(`Download canvas size: ${downloadCanvas.width}x${downloadCanvas.height}`);
                
                // Fill background
                downloadCtx.fillStyle = '#FFFFFF';
                downloadCtx.fillRect(0, 0, downloadCanvas.width, downloadCanvas.height);
                
                debugLog('Background filled');
                
                // Draw the QR code from displayed canvas
                const qrSize = 200;
                const qrX = (downloadCanvas.width - qrSize) / 2;
                const qrY = (downloadCanvas.height - qrSize) / 2;
                
                debugLog(`Drawing QR at position: ${qrX}, ${qrY}`);
                
                downloadCtx.drawImage(displayedCanvas, qrX, qrY, qrSize, qrSize);
                
                debugLog('QR code drawn on download canvas');
                
                // Add text labels
                downloadCtx.fillStyle = '#2c3e50';
                downloadCtx.font = 'bold 16px Arial, sans-serif';
                downloadCtx.textAlign = 'center';
                
                // Name
                downloadCtx.fillText(memberData.name, downloadCanvas.width / 2, qrY - 30);
                debugLog(`Added name: ${memberData.name}`);
                
                // Mobile number
                downloadCtx.fillStyle = '#6c757d';
                downloadCtx.font = '14px Arial, sans-serif';
                downloadCtx.fillText(memberData.mobile, downloadCanvas.width / 2, qrY - 10);
                debugLog(`Added mobile: ${memberData.mobile}`);
                
                // Convert to data URL
                debugLog('Converting canvas to data URL...');
                const dataURL = downloadCanvas.toDataURL('image/png', 1.0);
                
                if (!dataURL || dataURL === 'data:,') {
                    debugLog('ERROR: Failed to generate data URL');
                    return;
                }
                
                debugLog(`Data URL generated (length: ${dataURL.length})`);
                
                // Create download link
                const link = document.createElement('a');
                link.download = `ebili-payment-qr-${memberData.mobile}.png`;
                link.href = dataURL;
                
                debugLog(`Download link created: ${link.download}`);
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                debugLog('=== Download triggered successfully ===');
                
            } catch (error) {
                debugLog(`ERROR in downloadQRCode: ${error.message}`);
                debugLog(`Stack trace: ${error.stack}`);
            }
        }

        function shareQRCode() {
            debugLog('=== Starting QR Code Share ===');
            
            try {
                const displayedCanvas = document.getElementById('qrCanvas');
                if (!displayedCanvas) {
                    debugLog('ERROR: QR canvas not found for sharing');
                    return;
                }
                
                debugLog('Creating share canvas...');
                
                const shareCanvas = document.createElement('canvas');
                const shareCtx = shareCanvas.getContext('2d');
                
                shareCanvas.width = 300;
                shareCanvas.height = 300;
                
                // Fill background
                shareCtx.fillStyle = '#FFFFFF';
                shareCtx.fillRect(0, 0, shareCanvas.width, shareCanvas.height);
                
                // Draw QR code
                const qrSize = 150;
                const qrX = (shareCanvas.width - qrSize) / 2;
                const qrY = (shareCanvas.height - qrSize) / 2;
                
                shareCtx.drawImage(displayedCanvas, qrX, qrY, qrSize, qrSize);
                
                // Add text
                shareCtx.fillStyle = '#2c3e50';
                shareCtx.font = 'bold 14px Arial, sans-serif';
                shareCtx.textAlign = 'center';
                shareCtx.fillText(memberData.name, shareCanvas.width / 2, qrY - 20);
                
                shareCtx.fillStyle = '#6c757d';
                shareCtx.font = '12px Arial, sans-serif';
                shareCtx.fillText(memberData.mobile, shareCanvas.width / 2, qrY - 5);
                
                debugLog('Share canvas prepared');
                
                // Convert to blob for sharing
                shareCanvas.toBlob(function(blob) {
                    if (!blob) {
                        debugLog('ERROR: Failed to create blob for sharing');
                        return;
                    }
                    
                    debugLog(`Blob created (size: ${blob.size} bytes)`);
                    
                    const shareText = `Send money to ${memberData.name} (${memberData.mobile}) via E-Bili.\n\nScan the QR code to transfer money instantly!`;
                    
                    if (navigator.share && navigator.canShare) {
                        const filesArray = [new File([blob], `ebili-qr-${memberData.mobile}.png`, { type: 'image/png' })];
                        
                        if (navigator.canShare({ files: filesArray })) {
                            debugLog('Using native share API...');
                            navigator.share({
                                title: 'E-Bili Payment QR Code',
                                text: shareText,
                                files: filesArray
                            }).then(() => {
                                debugLog('Share completed successfully');
                            }).catch((error) => {
                                debugLog(`Share failed: ${error.message}`);
                                fallbackShare(shareText);
                            });
                        } else {
                            debugLog('File sharing not supported, using text share...');
                            navigator.share({
                                title: 'E-Bili Payment QR Code',
                                text: shareText
                            }).catch((error) => {
                                debugLog(`Text share failed: ${error.message}`);
                                fallbackShare(shareText);
                            });
                        }
                    } else {
                        debugLog('Native share not supported, using fallback...');
                        fallbackShare(shareText);
                    }
                }, 'image/png', 1.0);
                
            } catch (error) {
                debugLog(`ERROR in shareQRCode: ${error.message}`);
            }
        }

        function fallbackShare(text) {
            debugLog('Using fallback share method...');
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    debugLog('Text copied to clipboard');
                    alert('QR code details copied to clipboard!');
                }).catch(() => {
                    debugLog('Clipboard write failed');
                    alert('Share not supported on this device');
                });
            } else {
                debugLog('Clipboard API not available');
                alert('Share not supported on this device');
            }
        }
    </script>
</body>
</html>